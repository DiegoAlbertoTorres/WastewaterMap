<!DOCTYPE html>
<html>
<head>
	<title>Wastewater Treatment 2014</title>
	<meta charset="utf-8" />

	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<script src="./leaflet.js"></script>
	<script src="./world_10m_withlessdata.js"></script>
	<script src="./jquery-1.11.1.min.js"></script>
	<script src="./slide.js"></script>
	<script src="./tinycolor.js"></script>
	<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
	
	<script src="./leaflet-search.js"></script>
	<link rel="stylesheet" href="./leaflet-search.css" />
	<link rel="stylesheet" href="./leaflet.css" />
	<link rel="stylesheet" href="./style.css" />

	<script>
		var geojson;
		var map;
		var info = L.control();
		var legend = L.control({position: 'bottomleft'});

		var mouseX, mouseY;
		
		//$.ajax({
			//type: "GET",
			//url: "WASTE_2014_SORTED.csv",
			//dataType: "text",
			//success: function(data){ /*processData(data, "WASTECXN");*/ getWaste();}
		//});
		getWaste();
		
		$(document).mousemove( function(e) {
		   mouseX = e.pageX; 
		   mouseY = e.pageY;
		   // console.log(mouseX, mouseY);
		   $('.popup').css({'top': (mouseY + 10),'left': mouseX, 'position': 'absolute'}).fadeIn('slow');
		});  
		
		$(document).ready(function() {
			$('#slide_out_info').tabSlideOut({
				tabHandle: '.handle',                     //class of the element that will become your tab
				//Optionally can be set using css
				height: '110px',                     //height of tab image           //Optionally can be set using css
				width: '30px',                       //width of tab image            //Optionally can be set using css
				tabLocation: 'left',                      //side of screen where tab lives, top, right, bottom, or left
				speed: 400,                               //speed of animation
				action: 'click',                  //options: true makes it stick(fixed position) on scroll
			});

			map = L.map('map', {
				maxBounds: [[-80, -180],[90, 180]],
				center: [42,0],
				zoom: 2,
				minZoom: 2,
				maxZoom: 7,
			});
			
			info.addTo(map);
			legend.addTo(map);
			// info.setOpacity(1);
			
			// Bathymetry layer
			L.tileLayer('./BestTiles/{id}/{z}/{x}/{y}.png', {
				id: '',
				//unloadInvisibleTiles: true,
				//updateWhenIdle: false
			}).addTo(map);
		});
		
		function addGeoJson(){
			geojson = L.geoJson(countries, {style: style, onEachFeature: onEachFeature}).addTo(map);
				
			var searchControl = new L.Control.Search({layer: geojson, propertyName: 'goodName', circleLocation: false, autoType: false, zoom: false, });
			searchControl.on('search_locationfound', function(e) {
				geojson.eachLayer(function(layer) {
					geojson.resetStyle(layer);
				}); 

				e.layer.setStyle({
					weight: 2,
					color: "#FABB34",
					dashArray: '',
					// Have to add a ligthen function;
					fillOpacity: 0.2
				});
				// Find biggest area
				//var largestRegion = getLargestBoundingRegion(e.layer.feature);
				//var bounds = L.polygon(largestRegion).getBounds();
				//map.fitBounds(bounds);
				//console.log(bounds);
				 
				//console.log(e.layer);
				map.fitBounds(e.layer.getBounds());
				info.update(e.layer.feature.properties);

			}).on('search_collapsed', function(e) {
				geojson.eachLayer(function(layer) {
					geojson.resetStyle(layer);
				}); 
			});
			map.addControl(searchControl);
		}
		
		function style(feature){
			return {
				// "fillColor": colorPal(feature.properties.val),
				// "color": "#fff",
				// "weight": 1.5,
				// "fillOpacity": 0.8
				"fillOpacity": 0,
				"weight": 0,
				"fillColor": "#fff"
			};
		};
		
		// Color palette
		function colorPal(val){
			// Base color, set initial sat and lum here
			var col = tinycolor("hsv(0, 80%, 80%)").toHsv();
			
			// Color range angle
			var range = 60;
			// Color angle offset
			var offset = 200;
			
			// Saturation is val
			if (val == -9999) return "#999";
			
			// Single color
			//col.s = Math.pow((val)/150 + 0.25, 1);
			
			// Normal color direction
			col.h = (val*3.6) * (range/360) + offset;
			// Flipped color direction
			//col.h = (range + offset) - (val*3.6) * (range/360);
			
			//console.log(tinycolor(col).toHexString());
			return tinycolor(col).toHexString();
		}
		
		function hoverFeature(e) {
			var props = e.target.feature.properties;
			var layer = e.target;

			// console.log(e.target);
			// e.target.bindPopup("<b>Score for " + props.name + " is:</b><br>" + props.val +" out of 100.").openPopup();

			//$("body").append("<div class=popup id=popup_" +props.name +"><b>Score for " + props.name + " is:</b><br>" + props.val +" out of 100.</div>");


			layer.setStyle({
				weight: 2,
				color: "#FABB34",
				dashArray: '',
				// Have to add a ligthen function;
				fillOpacity: 0.2
			});

			if (!L.Browser.ie && !L.Browser.opera) {
				layer.bringToFront();
			}
			info.update(layer.feature.properties);
		}
		
		function unhoverFeature(e) {
			//var props = e.target.feature.properties;
			//$("#popup_" + props.name).remove();
			geojson.resetStyle(e.target);
			info.update();
		}
		
		function zoomToFeature(e) {
			map.fitBounds(e.target.getBounds());
		}

		function onEachFeature(feature, layer) {
			layer.on({
				mouseover: hoverFeature,
				mouseout: unhoverFeature,
				click: zoomToFeature
			});
		}

		info.onAdd = function (map) {
			this._div = L.DomUtil.create('div', 'countryInfo'); // create a div with a class "info"
			var infoPanel = $(this)[0]._div;
			
			$(infoPanel).empty();
			
			var infoBreakdown = "";
			infoBreakdown += "<div class=breakHeader id=breakCountry> <span> <b>National Wastewater Treatment Score</b> </span> </div>";
			infoBreakdown += "<div class=breakData id=dataCountry> <span>" + "-" + "</span> </div> <br /> <br />";
			infoBreakdown += "<div class=breakHeader id=breakWasteCXN> <span> <b>Wastewater Treatment Level Times Connection Rate</b> </span> </div>";
			infoBreakdown += "<div class=breakData id=dataWasteCXN> <span>" + "-" + "</span> </div> <br /> <br />";
			infoBreakdown += "<div class=breakHeader id=breakWaste> <span> <b>Percentage of Population Connected</b> </span> </div>";
			infoBreakdown += "<div class=breakData id=dataWaste> <span>" + "-" + "</span> </div> <br  /> <br />";
			infoBreakdown += "<div class=breakHeader id=breakCXN> <span> <b>Wastewater Treatment Level</b> </span> </div>";
			infoBreakdown += "<div class=breakData id=dataCXN> <span>" + "-" + "</span> </div> <br /> <br />";
			$(infoPanel).append(infoBreakdown);
			return this._div;
		};
		
		info.update = function (props) {
			var infoPanel = $(this)[0]._div
			
			var infoBreakdown = "",
				name = "-",
				cxn = "-",
				waste = "-",
				wastecxn = "-";

			$(infoPanel).find(".breakData").each(function(){
				if (($(this).css("opacity") != 1) && ($(this).attr("fadingOut") === undefined)){
					// Remove everything that is trying to fade in
					$(this).remove();
				}
				else if ($(this).css("opacity") == 1 && ($(this).attr("fadingOut") === undefined)){
					// Fade out established element
					$(this).attr("fadingOut", "true");
					$(this).fadeOut(700, function() { $(this).remove(); });
				}
				//else
					//$(this).stop().fadeOut(700, function() { $(this).remove(); });
			});
			if (props){
				if (props.goodName == undefined){
					name = "???";
				}
				else{
					name = props.goodName;
					if (props.val == undefined || props.val == -9999){
						cxn = "No data";
						waste = "No data";
						wastecxn = "No data";
					}
					else{
						cxn = props.cxn;
						waste = props.waste;
						wastecxn = props.val;
					}
				}
			}
				
			var dataCountry = "<div class=breakData id=dataCountry> <span>" + name + "</span> </div>";
			var dataWaste = "<div class=breakData id=dataWaste> <span>" + waste + "</span> </div>";
			var dataCXN = "<div class=breakData id=dataCXN> <span>" + cxn + "</span> </div>";
			var dataWasteCXN = "<div class=breakData id=dataWasteCXN> <span>" + wastecxn + "</span> </div>";
			
			// Try to fade in newly hovered country
			$(dataCountry).hide().insertAfter("#breakCountry").fadeIn(700);
			$(dataWaste).hide().insertAfter("#breakWaste").fadeIn(700);
			$(dataCXN).hide().insertAfter("#breakCXN").fadeIn(700);
			$(dataWasteCXN).hide().insertAfter("#breakWasteCXN").fadeIn(700);
		};

		legend.onAdd = function (map) {

			var div = L.DomUtil.create('div', 'info legend'),
				grades = [0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100],
				labels = [];

			div.innerHTML += "<b>Country Score</b> <br/>";
			// loop through our density intervals and generate a label with a colored square for each interval
			for (var i = 0; i < grades.length - 1; i++) {
				// console.log(colorPal(grades[i]));
				div.innerHTML += '<i style="background:' + colorPal(grades[i]) + '"></i> ' +
					grades[i] + (grades[i + 1] ? '&ndash;' + grades[i + 1] + '<br>' : '+');
			}

			return div;
		};

		legend.addTo(map);

		function processData(allText, file) {
			var allTextLines = allText.split(/\r\n|\n/);
			var headers = allTextLines[0].split(',');
			var lines = [];

			for (var i=1; i<allTextLines.length; i++) {
				var data = allTextLines[i].split(',');
				if (data.length == headers.length) {

					var tarr = [];
					for (var j=0; j<headers.length; j++) {
						tarr.push(headers[j]+":"+data[j]);
					}
					lines.push(tarr);
				}
			}
			// Load data into JSON object
			if (file == "WASTECXN"){
				for(i = 0; i < countries.features.length; i++){
					countries.features[i].properties.goodName = countries.features[i].properties.NAME;
					countries.features[i].properties.iso3 = countries.features[i].properties.ADM0_A3;
					countries.features[i].properties.val = -9999;
					for (j = 0; j < lines.length; j++){
						if (countries.features[i].properties.iso3 == lines[j][1].split(':')[1]){
							countries.features[i].properties.val = parseInt(lines[j][27].split(':')[1]);
						}
					}	
				}
			}
			else if (file == "WASTE"){
				for(i = 0; i < countries.features.length; i++){
					countries.features[i].properties.waste = -9999;
					for (j = 0; j < lines.length; j++){
						if (countries.features[i].properties.iso3 == lines[j][1].split(':')[1]){
							//console.log(countries.features[i].properties.iso3, lines[j][27]);
							countries.features[i].properties.waste = parseInt(lines[j][27].split(':')[1]);
						}
					}	
				}
			}
			else if (file == "CXN"){
				for(i = 0; i < countries.features.length; i++){
					countries.features[i].properties.cxn = -9999;
					for (j = 0; j < lines.length; j++){
						if (countries.features[i].properties.iso3 == lines[j][1].split(':')[1]){
							//console.log(countries.features[i].properties.iso3, lines[j][22]);
							countries.features[i].properties.cxn = parseInt(lines[j][22].split(':')[1]);
						}
					}	
				}
			}
			
		}

		function getLargestBoundingRegion(country) {

			var largestRegionCoords;
			var path = d3.geo.path();

			//Check if the country has more than one bounding region.
			if (country.geometry.coordinates.length > 1) {
			    var regionToReturn = {        
			        "type": "Feature",
			        "geometry": {
			            "type": "Polygon", 
			            "coordinates": country.geometry.coordinates[0]
			        }           
			    };

			    for (var i=1; i<country.geometry.coordinates.length; i++) {
			        var testRegion = {        
			                "type": "Feature",
			                "geometry": {
			                    "type": "Polygon", 
			                    "coordinates": country.geometry.coordinates[i]
			                },            
			        };

			        if (path.area(testRegion) > path.area(regionToReturn)) {
			            regionToReturn = testRegion;    
			            largestRegionCoords = country.geometry.coordinates[i][0]; 
			        }
			    }
		    } 
		    else {    
		        largestRegionCoords = country.geometry.coordinates[0][0];
		    }
			return largestRegionCoords;
		}
		
		function getWaste(){
			$.ajax({
				type: "GET",
				url: "WASTE.csv",
				dataType: "text",
				success: function(data){ processData(data, "WASTE"); getCXN();}
			});
		}
		
		function getCXN(){
			$.ajax({
				type: "GET",
				url: "CXN.csv",
				dataType: "text",
				success: function(data){ processData(data, "CXN"); addGeoJson();}
			});
		}

	</script>
</head>
<body>
	<div id="map"></div>
	<div id="slide_out_info">
    	<a class="handle" href="#">
    		<span id="rotated_text">MAP INFO</span>
      	</a>
      	<div class="content">
			<div class="text" style="font-family: arial; font-size: 14px;">
				<h1 style="color: #366ab2">Lorem Ipsum</h1> <br>
				<strong>Lorem Ipsum</strong><br><br>
				<i>Prepared for the 2014 Environmental Performance Index</i> <br><br>

				Lorem ipsum dolor sit amet, consectetur adipiscing elit. Vivamus eget condimentum nisi. Vestibulum et nunc eget metus condimentum blandit ut vel nisl. Maecenas at placerat leo. Donec nec metus risus. Cras magna nisi, ornare a sapien euismod, laoreet placerat nisi. Pellentesque sit amet blandit nunc. Interdum et malesuada fames ac ante ipsum primis in faucibus. Morbi iaculis ante sed semper lobortis. Donec tellus nunc, sollicitudin in massa in, dignissim eleifend massa. Curabitur varius libero eros, non ornare nisi imperdiet ac. Aenean sollicitudin purus sit amet faucibus feugiat.
				<br><br><br>
				Citation:<br><br>
				Johnson, L. (2014). National Status of the Dirty Dozen POPs regulation through the Stockholm Convention. New Haven, CT: Yale Center for Environmental Law & Policy.

				<br><br>
				<i>Map created by Diego Torres (Yale College '16)</i>
      		</div>
  		</div>
    </div>
</body>
</html>
